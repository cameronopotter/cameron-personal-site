# Prometheus alerting rules for Digital Greenhouse
# Comprehensive monitoring and alerting for all system components

groups:
  - name: digital-greenhouse-system
    rules:
      # Service availability alerts
      - alert: DigitalGreenhouseDown
        expr: up{job="digital-greenhouse-backend"} == 0
        for: 30s
        labels:
          severity: critical
          service: digital-greenhouse
        annotations:
          summary: "Digital Greenhouse backend is down"
          description: "Digital Greenhouse backend has been down for more than 30 seconds"
          runbook_url: "https://wiki.digital-greenhouse.dev/runbooks/service-down"

      - alert: DigitalGreenhouseFrontendDown
        expr: up{job="digital-greenhouse-frontend"} == 0
        for: 1m
        labels:
          severity: critical
          service: frontend
        annotations:
          summary: "Digital Greenhouse frontend is down"
          description: "Digital Greenhouse frontend has been down for more than 1 minute"

      # Performance alerts
      - alert: DigitalGreenhouseHighResponseTime
        expr: histogram_quantile(0.95, rate(digital_greenhouse_http_request_duration_seconds_bucket[5m])) > 1
        for: 2m
        labels:
          severity: warning
          service: digital-greenhouse
        annotations:
          summary: "High response time detected"
          description: "95th percentile response time is {{ $value }}s"
          value: "{{ $value }}"

      - alert: DigitalGreenhouseHighErrorRate
        expr: rate(digital_greenhouse_http_requests_total{status=~"4..|5.."}[5m]) / rate(digital_greenhouse_http_requests_total[5m]) * 100 > 5
        for: 2m
        labels:
          severity: critical
          service: digital-greenhouse
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value }}%"
          value: "{{ $value }}"

      - alert: DigitalGreenhouseLowPerformanceScore
        expr: digital_greenhouse_health_score < 70
        for: 5m
        labels:
          severity: warning
          service: digital-greenhouse
        annotations:
          summary: "Performance score is low"
          description: "System health score is {{ $value }}%"
          value: "{{ $value }}"

  - name: digital-greenhouse-resources
    rules:
      # Resource utilization alerts
      - alert: DigitalGreenhouseHighMemoryUsage
        expr: (container_memory_usage_bytes{name="digital-greenhouse-backend"} / container_spec_memory_limit_bytes{name="digital-greenhouse-backend"}) * 100 > 85
        for: 5m
        labels:
          severity: warning
          service: digital-greenhouse
        annotations:
          summary: "High memory usage"
          description: "Memory usage is {{ $value }}%"
          value: "{{ $value }}"

      - alert: DigitalGreenhouseHighCPUUsage
        expr: rate(container_cpu_usage_seconds_total{name="digital-greenhouse-backend"}[5m]) * 100 > 80
        for: 5m
        labels:
          severity: warning
          service: digital-greenhouse
        annotations:
          summary: "High CPU usage"
          description: "CPU usage is {{ $value }}%"
          value: "{{ $value }}"

      - alert: DigitalGreenhouseDiskSpaceLow
        expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 15
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "Low disk space"
          description: "Available disk space is {{ $value }}%"
          value: "{{ $value }}"

  - name: digital-greenhouse-database
    rules:
      # Database performance alerts
      - alert: DigitalGreenhouseDBSlowQueries
        expr: histogram_quantile(0.95, rate(digital_greenhouse_db_query_duration_seconds_bucket[5m])) > 0.5
        for: 2m
        labels:
          severity: warning
          service: database
        annotations:
          summary: "Slow database queries detected"
          description: "95th percentile query time is {{ $value }}s"
          value: "{{ $value }}"

      - alert: DigitalGreenhouseDBHighConnections
        expr: digital_greenhouse_db_connections_active / digital_greenhouse_db_connections_max * 100 > 80
        for: 2m
        labels:
          severity: warning
          service: database
        annotations:
          summary: "High database connection usage"
          description: "Database connection usage is {{ $value }}%"
          value: "{{ $value }}"

      - alert: DigitalGreenhouseDBDown
        expr: up{job="postgres"} == 0
        for: 30s
        labels:
          severity: critical
          service: database
        annotations:
          summary: "Database is down"
          description: "PostgreSQL database has been down for more than 30 seconds"

  - name: digital-greenhouse-cache
    rules:
      # Cache performance alerts
      - alert: DigitalGreenhouseLowCacheHitRate
        expr: rate(digital_greenhouse_cache_hits_total[5m]) / (rate(digital_greenhouse_cache_hits_total[5m]) + rate(digital_greenhouse_cache_misses_total[5m])) * 100 < 70
        for: 5m
        labels:
          severity: warning
          service: cache
        annotations:
          summary: "Low cache hit rate"
          description: "Cache hit rate is {{ $value }}%"
          value: "{{ $value }}"

      - alert: DigitalGreenhouseRedisDown
        expr: up{job="redis"} == 0
        for: 30s
        labels:
          severity: warning
          service: cache
        annotations:
          summary: "Redis cache is down"
          description: "Redis cache has been down for more than 30 seconds"

  - name: digital-greenhouse-frontend
    rules:
      # Frontend performance alerts
      - alert: DigitalGreenhouseLowFPS
        expr: digital_greenhouse_fps_current < 30
        for: 1m
        labels:
          severity: warning
          service: frontend
        annotations:
          summary: "Low FPS detected"
          description: "Current FPS is {{ $value }}"
          value: "{{ $value }}"

      - alert: DigitalGreenhouseHighRenderTime
        expr: digital_greenhouse_render_time_milliseconds > 20
        for: 2m
        labels:
          severity: warning
          service: frontend
        annotations:
          summary: "High render time detected"
          description: "Render time is {{ $value }}ms"
          value: "{{ $value }}"

      - alert: DigitalGreenhouseHighMemoryUsageFrontend
        expr: digital_greenhouse_js_heap_used_bytes / 1024 / 1024 > 256
        for: 5m
        labels:
          severity: warning
          service: frontend
        annotations:
          summary: "High frontend memory usage"
          description: "JavaScript heap usage is {{ $value }}MB"
          value: "{{ $value }}"

  - name: digital-greenhouse-business
    rules:
      # Business metric alerts
      - alert: DigitalGreenhouseLowUserEngagement
        expr: rate(digital_greenhouse_projects_viewed_total[1h]) < 5
        for: 1h
        labels:
          severity: warning
          service: business
        annotations:
          summary: "Low user engagement"
          description: "Project views per hour: {{ $value }}"
          value: "{{ $value }}"

      - alert: DigitalGreenhouseHighBounceRate
        expr: digital_greenhouse_session_bounce_rate > 60
        for: 30m
        labels:
          severity: warning
          service: business
        annotations:
          summary: "High bounce rate detected"
          description: "Bounce rate is {{ $value }}%"
          value: "{{ $value }}"

      - alert: DigitalGreenhouseNoActiveUsers
        expr: digital_greenhouse_active_users_total == 0
        for: 10m
        labels:
          severity: warning
          service: business
        annotations:
          summary: "No active users"
          description: "No active users for the past 10 minutes"

  - name: digital-greenhouse-security
    rules:
      # Security alerts
      - alert: DigitalGreenhouseSecurityTooManyFailedLogins
        expr: rate(digital_greenhouse_failed_login_attempts_total[5m]) > 10
        for: 1m
        labels:
          severity: warning
          service: security
        annotations:
          summary: "Too many failed login attempts"
          description: "{{ $value }} failed login attempts per second"
          value: "{{ $value }}"

      - alert: DigitalGreenhouseSecuritySuspiciousActivity
        expr: rate(digital_greenhouse_suspicious_requests_total[5m]) > 5
        for: 2m
        labels:
          severity: warning
          service: security
        annotations:
          summary: "Suspicious activity detected"
          description: "{{ $value }} suspicious requests per second"
          value: "{{ $value }}"

  - name: digital-greenhouse-external
    rules:
      # External service alerts
      - alert: DigitalGreenhouseExternalAPIDown
        expr: digital_greenhouse_external_api_up{service=~"github|spotify|weather"} == 0
        for: 2m
        labels:
          severity: warning
          service: external
        annotations:
          summary: "External API is down"
          description: "{{ $labels.service }} API has been down for 2 minutes"

      - alert: DigitalGreenhouseExternalAPIHighLatency
        expr: digital_greenhouse_external_api_duration_seconds > 5
        for: 5m
        labels:
          severity: warning
          service: external
        annotations:
          summary: "High external API latency"
          description: "{{ $labels.service }} API latency is {{ $value }}s"
          value: "{{ $value }}"